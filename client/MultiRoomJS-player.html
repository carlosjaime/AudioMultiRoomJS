<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html"> -->
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<!-- <link rel="import" href="/bower_components/paper-dialog/paper-dialog.html"> -->
<!-- <link rel="import" href="/bower_components/paper-input/paper-input.html"> -->
<link rel="import" href="../bower_components/paper-styles/typography.html">
<dom-module id="multiroomjs-player">
  <template>
    <style>
      /*:host {
        display: block;
        height: 100vh;
      }*/
      /*.page-content {
        height: 100%;
        display: flex;
        flex-direction: column;

      }*/
      .placeholder {
        width: 100%;
        height: 200px;
        background-color: darkGrey;
        display: flex;

      }
      .big {
        --iron-icon-width: 50px;
        --iron-icon-height: 50px
      }
      .white {
        color: white;
      }
      .card-actions {
        /*float: right;*/
      }
      /*.fixed {
        position: fixed;
        width: 100%;
      }*/
      .center {
        align-items: center;
        align-content: center;
        justify-content: center;
      }
      .sp-around {
        align-items: space-around;
        align-content: space-around;
        justify-content: space-around;
      }
      .flex {
        display: flex;
      }
      .full {
        height: 100%;
      }

      .placeholder {
        /*float: left;*/
        order: -1;
        transition: 300ms
      }

      .player {
        /*width: 80%;
        margin: 10%;*/
        display: flex;
        flex-direction: column;
      }
    </style>

      <paper-card elevation="5" heading="{{music}}" class="player">
          <div id="placeholder" class="placeholder flex center">
            <iron-icon class="white big" icon="av:library-music"></iron-icon>
          </div>
          <!-- <div class="title-text paper-card">
          <h2>{{music}}</h2>
          </div> -->
          <div class="content">
            <!-- <div class="header">
              <div class="title">
                {{music}}
              </div>
            </div> -->

            <!-- <template is="dom-if" if="{{connected}}"> -->
              <div class="card-actions flex sp-around">

                <paper-icon-button id="sync" on-click="tap" icon="notification:sync"></paper-icon-button>
                <paper-icon-button id="pause" on-click="tap" icon="{{playAndPause}}"></paper-icon-button>
                <paper-icon-button id="next" on-click="tap" icon="av:skip-next"></paper-icon-button>
                <a href="https://github.com/ranfdev/MultiRoomJS-client">
                  <paper-icon-button icon="code"></paper-icon-button>
                </a>


              </div>
            <!-- </template> -->
            <!-- <template is="dom-if" if="{{!connected}}">
              <div class="card-content">

                <p>You need to connect to your MultiRoomJS server to listen your favourite music. If you have'nt already, set your server host in the settings</p>
              </div>
              <div class="card-actions">
                <paper-button onclick="settings.open()">Settings</paper-button>
                <paper-button on-click="start">Connect</paper-button>
              </div>
            </template> -->

          </div>


      </paper-card>


    <!-- <paper-dialog id="settings" with-backdrop>
      <h2>Settings</h2>
      <paper-input value="{{server}}" label="Server host"></paper-input>
      <paper-button onclick="settings.close()">Cancel</paper-button>
      <paper-button on-click="start">Connect</paper-button>
    </paper-dialog> -->

    <!-- <app-localstorage-document key="server" data="{{server}}"></app-localstorage-document> -->
    <!-- <h2>Hello [[prop1]]</h2> -->
  </template>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="../bower_components/howler.js/dist/howler.min.js" charset="utf-8"></script>
  <script>
    Polymer({

      is: 'multiroomjs-player',

      properties: {
        prop1: {
          type: String,
          value: 'MultiRoomJS-client-app',
        },
        music: {
            value: 'Connect first'
        },
        connected: {
            value: false
        }
      },
      ready: function() {
          var ctx = this;
          var
              socket,
              btns,
              host,
              time = {
                  ding: null,
                  dong: null,
                  delay: null
              };
          console.log(ctx.music);
          // ctx.start = function() {
          //     settings.close();
          //     this.connect(this.server);
          // };
          ctx.changeColor = function (color) {
            ctx.$.placeholder.style.backgroundColor = color;
          };
          ctx.tap = function(e) {

              // console.log(e.currentTarget);
              ctx.req(e.currentTarget.id);
          };
          ctx.playAndPause = 'playing';
          ctx.isConnected = function() {
              return false;
          };
          ctx.connect = function(address) {
              console.log('connecting to', this.server);

              host = address;
              socket = io.connect(address);
              ctx.connected = true;
              // then

              socket.on('play', ctx.play);
              socket.on('pause', ctx.pause);
              socket.on('restart', function() {
                  location.reload();
              });
              socket.on('sync', function(ms) {
                  ctx.sync(ms);
              });
              socket.on('ding', ctx.ding);
              socket.on('dong', function() {
                  time.dong = performance.now();
                  time.delay = (time.dong - time.ding) * 1.5 / 100;
                  // displayDelay();
              });
              socket.on('playerData', function(data) {
                  if (typeof sound != 'undefined') {
                      sound.stop();
                  }
                  // console.log('received music data', data);
                  // console.log(ctx);
                  ctx.loadSong(data.current);
                  setTimeout(function() {
                      ctx.preloadSong(data.next);
                  }, 10000);

              });
          };
          ctx.loadSong = function(currentSong) {
              // console.log(host + '/' + currentSong);
              sound = new Howl({
                  src: host + '/' + currentSong,
                  autoplay: false,
                  autoSuspend: false,
                  onload: function() {
                      socket.emit('loaded');
                      console.log('ready');
                  },
                  onend: function() {
                      ctx.req('next');
                  }
              });
              ctx.music = currentSong;
          };
          ctx.play = function() {
              ctx.changeColor('#3f51b5');
              ctx.playAndPause = 'av:pause';

              sound.play();
              console.log('playing');
          };
          ctx.pause = function() {
              ctx.changeColor('darkGrey');
              ctx.playAndPause = 'av:play-arrow';

              sound.pause();
              console.log('paused');
          };
          ctx.req = function(what) {
              // console.log(what);
              if (what == 'sync') {
                  data = sound.seek();
                  socket.emit(what + 'Req', data);
                  console.log('req', what, data);
              } else {
                socket.emit(what + 'Req');
              }

          };
          ctx.ding = function() {
              time.ding = performance.now();
              socket.emit('ding');
          };
          // ctx.connected = function() {
          //
          // };
          ctx.preloadSong = function(nextSong) {
              new Howl({
                  src: host + '/' + nextSong,
                  autoplay: false
              });
          };
          ctx.sync = function(ms) {
              // ctx.ding();
              console.log('received sync', ms);

              // setTimeout(function () {
                sound.seek(time.delay + ms);
              // },1000);
          };
          console.log('origin',window.location.origin);
          ctx.connect(window.location.origin);
      }

    });
  </script>
</dom-module>
