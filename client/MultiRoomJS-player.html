<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- <link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html"> -->
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="/bower_components/paper-slider/paper-slider.html">
<!-- <link rel="import" href="/bower_components/paper-dialog/paper-dialog.html"> -->
<!-- <link rel="import" href="/bower_components/paper-input/paper-input.html"> -->
<link rel="import" href="/bower_components/paper-styles/typography.html">
<dom-module id="multiroomjs-player">
  <template>
    <style>

      .placeholder {
        width: 100%;
        height: 200px;
        background-color: darkGrey;
        display: flex;

      }
      .big {
        --iron-icon-width: 50px;
        --iron-icon-height: 50px
      }
      .white {
        color: white;
      }

      .center {
        align-items: center;
        align-content: center;
        justify-content: center;
      }
      .sp-around {
        align-items: space-around;
        align-content: space-around;
        justify-content: space-around;
      }
      .flex {
        display: flex;
      }
      .full {
        height: 100%;
      }

      .placeholder {
        order: -1;
        transition: 300ms
      }

      .player {
        display: flex;
        flex-direction: column;
      }

      paper-slider {
        width: 100%
      }
    </style>

      <paper-card elevation="5" heading="[[song.title]]" class="player">
          <div id="placeholder" class="placeholder flex center">
            <iron-icon class="white big" icon="av:library-music"></iron-icon>
          </div>
            <div class="card-content">
              <paper-slider id="timeSlider" on-change="seekSong" pin min="0" value="{{song.time.current}}" max="[[song.time.duration]]"></paper-slider>
            </div>
              <div class="card-actions flex sp-around">
                <paper-icon-button id="sync" on-click="tap" icon="notification:sync"></paper-icon-button>
                <paper-icon-button id="pause" on-click="tap" icon="{{playAndPause}}"></paper-icon-button>
                <paper-icon-button id="next" on-click="tap" icon="av:skip-next"></paper-icon-button>
                <a href="https://github.com/ranfdev/MultiRoomJS-client">
                 <paper-icon-button icon="code"></paper-icon-button>
                </a>
              </div>

      </paper-card>
  </template>
<script src="/bower_components/howler.js/dist/howler.min.js" charset="utf-8"></script>
  <script>
    Polymer({
      is: 'multiroomjs-player',
      properties: {
        prop1: {
          type: String,
          value: 'MultiRoomJS-client-app',
        },
        song: {
            type: Object,
            value: {
              title: 'Loading...',
              time: {
                duration: 100,
                current: 0}
              }
        },
        connected: {
            value: false
        },
        playAndPause: {
          value: 'av:pause'
        }
      },
      ready: function () {
        var ctx = this;
        pinuzzo = 'gg';
        var shell = document.querySelector('multiroomjs-shell');
        ctx.pause = function () {
          ctx.changeColor('darkGrey');
          ctx.playAndPause = 'av:play-arrow';
          sound.pause();
          console.log('paused');
        };

        ctx.sync = function(time) {
            console.log('received sync', time);
            sound.seek(shell.time.delay + time);
        };
        ctx.loadSong = function(currentSong) {
            sound = new Howl({
                src: currentSong,
                autoplay: false,
                autoSuspend: false,
                onload: function() {
                    shell.socket.emit('loaded');
                    console.log('ready');
                    ctx.set('song.time.duration', sound.duration());
                    ctx.timeSlider();

                },
                onplay: function() {
                  shell.req('sync');
                }
            });

            ctx.set('song.title', currentSong.replace(window.location.origin + '/', ''));
            ctx.set('song.title', ctx.song.title.replace('.mp3', ''));
        };
        ctx.timeSlider = function() {
          if (ctx.$.timeSlider.pointerDown == false) {
            ctx.set('song.time.current', sound.seek());
          }
          setTimeout(ctx.timeSlider,1000);
        };
        ctx.seekSong = function() {
          console.log('down', ctx.song.time.current);
          sound.seek(ctx.song.time.current);
          shell.req('sync');
        };
        ctx.changeColor = function(color) {
          ctx.$.placeholder.style.backgroundColor = color;
        };
        ctx.play = function() {
            ctx.changeColor('#1565c0');
            ctx.playAndPause = 'av:pause';
            sound.play();
            console.log('playing');
        };
        ctx.tap = function(e) {
            shell.req(e.currentTarget.id);
        };
      }

    });
  </script>
</dom-module>
