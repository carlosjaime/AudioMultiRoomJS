<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- <link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html"> -->
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="/bower_components/paper-slider/paper-slider.html">
<!-- <link rel="import" href="/bower_components/paper-dialog/paper-dialog.html"> -->
<!-- <link rel="import" href="/bower_components/paper-input/paper-input.html"> -->
<link rel="import" href="/bower_components/paper-styles/typography.html">
<dom-module id="audiomultiroomjs-player">
    <template>
    <style>

      .placeholder {
        width: 100%;
        height: 200px;
        background-color: darkGrey;
        display: flex;

      }
      .big {
        --iron-icon-width: 50px;
        --iron-icon-height: 50px
      }
      .white {
        color: white;
      }

      .center {
        align-items: center;
        align-content: center;
        justify-content: center;
      }
      .sp-around {
        align-items: space-around;
        align-content: space-around;
        justify-content: space-around;
      }
      .flex {
        display: flex;
      }
      .full {
        height: 100%;
      }

      .placeholder {
        order: -1;
        transition: 300ms
      }

      .player {
        display: flex;
        flex-direction: column;
      }

      paper-slider {
        width: 100%
      }
    </style>

      <paper-card elevation="5" heading="[[songTitle]]" class="player">
          <div id="placeholder" class="placeholder flex center">
            <iron-icon class="white big" icon="av:library-music"></iron-icon>
          </div>
            <div class="card-content">
              <paper-slider id="timeSlider" on-change="seekSong" secondary-progress="[[songBuffered]]" pin min="0" value="{{songTime}}" max="{{songDuration}}"></paper-slider>
            </div>
              <div class="card-actions flex sp-around">
                <paper-icon-button id="sync" on-click="tap" icon="notification:sync"></paper-icon-button>
                <paper-icon-button id="pause" on-click="tap" icon="{{playAndPause}}"></paper-icon-button>
                <paper-icon-button id="next" on-click="tap" icon="av:skip-next"></paper-icon-button>
                <a href="https://github.com/ranfdev/MultiRoomJS-client">
                 <paper-icon-button icon="code"></paper-icon-button>
                </a>
              </div>

      </paper-card>
  </template>
    <script>
        Polymer({
            is: 'audiomultiroomjs-player',
            properties: {
                prop1: {
                    type: String,
                    value: 'MultiRoomJS-client-app',
                },
                songBuffered: {
                    value: 0
                },
                connected: {
                    value: false
                },
                playAndPause: {
                    value: 'av:play-arrow'
                }
            },
            ready: function() {
                var ctx = this;
                player = this;
                ctx.sound = new Audio();
                ctx.sound.onloadeddata = function() {
                    console.log('loaded');
                    app.socket.emit('loaded');
                    ctx.songDuration = ctx.sound.duration;
                    ctx.timeSlider();
                };
                ctx.sound.onplay = function() {
                    ctx.changeColor('#1565c0');
                    ctx.playAndPause = 'av:pause';
                    app.req('sync');
                    console.log('playing');
                };
                ctx.sound.onpause = function() {
                  ctx.changeColor('darkGrey');
                  ctx.playAndPause = 'av:play-arrow';
                  console.log('paused');
                };
                ctx.pause = function() {
                    ctx.sound.pause();
                };
                ctx.sync = function(time) {
                    console.log('received sync', time);
                    ctx.sound.currentTime = app.time.delay + time;
                };
                ctx.loadSong = function(currentSong) {
                    ctx.sound.src = currentSong;
                    ctx.songTitle = currentSong.replace(window.location.origin + '/', '');
                    ctx.songTitle = ctx.songTitle.replace('.mp3', '');
                };
                ctx.timeSlider = function() {
                    if (ctx.$.timeSlider.pointerDown === false) {
                        ctx.songTime = ctx.sound.currentTime;
                        ctx.songBuffered = ctx.sound.buffered.end(0);
                    }
                    setTimeout(ctx.timeSlider, 1000);
                };
                ctx.seekSong = function() {
                    ctx.sound.currentTime = ctx.songTime;
                    app.req('sync');
                };
                ctx.changeColor = function(color) {
                    ctx.$.placeholder.style.backgroundColor = color;
                };
                ctx.play = function() {
                    ctx.sound.play();
                };
                ctx.tap = function(e) {
                    if (ctx.sound.played.length < 1) {
                      ctx.sound.play();
                    } else {
                      app.req(e.currentTarget.id);
                    }

                };
            }

        });
    </script>
</dom-module>
