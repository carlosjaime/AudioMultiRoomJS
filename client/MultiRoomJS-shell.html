<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="MultiRoomJS-player.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/app-route/app-route.html">
<link rel="import" href="bower_components/app-route/app-location.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="my-view1.html">
<link rel="import" href="my-view2.html">
<link rel="import" href="shared-styles.html">
<dom-module is="multiroomjs-shell">
    <style is="custom-style" include="shared-styles">
         :host {
            @apply(--paper-font-common-base);
        }

        app-toolbar {
            background-color: var(--paper-blue-800);
            color: white
        }
    </style>
    <template>
    <!-- <h1>Ciao</h1> -->
    <app-toolbar>
      <div main-title>MultiRoomJS</div>
      <paper-menu-button vertical-align="top" horizontal-align="right">
        <paper-icon-button class="dropdown-trigger" icon="more-vert"></paper-icon-button>
        <paper-menu class="dropdown-content">
          <paper-item><a href="/#/my-view2">Settings</a></paper-item>
          <paper-item><a href="https://github.com/ranfdev/MultiRoomJS-server">Code</a></paper-item>
        </paper-menu>
      </paper-menu-button>
    </app-toolbar>

    <app-location use-hash-as-path route="{{route}}"></app-location>
<app-route
    route="{{route}}"
    pattern="/:page"
    data="{{data}}">
</app-route>
<iron-pages selected="[[data.page]]" attr-for-selected="name" fallback-selection="my-view1">
  <my-view1 name="my-view1"></my-view1>
  <my-view2 name="my-view2"></my-view2>
</iron-pages>
  </template>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

    <script type="text/javascript">
        Polymer({
            is: 'multiroomjs-shell',
            ready: function() {
                var ctx = this;
                var player = document.querySelector('multiroomjs-player');

                ctx.time = {
                        ding: null,
                        dong: null,
                        delay: null
                };


                ctx.req = function(what) {
                      if (what == 'sync') {
                        // time.current = sound.seek();
                        // time.duration = sound.duration();
                        ctx.socket.emit(what + 'Req', {
                          current: sound.seek(),
                          duration: sound.duration()
                        });
                        // console.log('req', what, data);
                    } else {
                      ctx.socket.emit(what + 'Req');
                    }
                };


                ctx.ding = function() {
                    ctx.time.ding = performance.now();
                    ctx.socket.emit('ding');
                };

                ctx.connect = function(address) {
                    console.log('connecting to', address);

                    ctx.host = address;
                    ctx.socket = io.connect(address);
                    ctx.connected = true;
                    // then

                    ctx.socket.on('play', player.play);
                    ctx.socket.on('pause', player.pause);
                    ctx.socket.on('restart', function() {
                        location.reload();
                    });
                    ctx.socket.on('sync', function(ms) {
                        ctx.ding();
                        player.sync(ms);
                    });
                    ctx.socket.on('ding', ctx.ding);
                    ctx.socket.on('dong', function() {
                        ctx.time.dong = performance.now();
                        ctx.time.delay = (ctx.time.dong - ctx.time.ding) * 1.5 / 100;

                    });
                    ctx.socket.on('playerData', function(data) {
                        if (typeof sound != 'undefined') {
                            sound.stop();
                        }

                        player.loadSong(ctx.host + '/' + data.current);
                        setTimeout(function() {
                          ctx.req('syncReq');
                        }, 2000);

                    });


                };


            ctx.connect(window.location.origin);

            }

        });
    </script>
</dom-module>
